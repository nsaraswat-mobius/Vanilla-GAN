name: Upload Model one
description: Upload config.pbtxt, ONNX model file, and data file to MinIO with Triton directory structure
inputs:
- {name: Config file}  # config.pbtxt file path
- {name: ONNX file}  # ONNX model file path
- {name: Data file}  # Data file path (will be stored in version 1 directory)
- {name: Data file name, type: String}  # Data file name with extension (e.g., data.pkl)
- {name: MinIO bucket name, type: String}  # MinIO bucket name
- {name: Model name, type: String}  # Model name (e.g., mpqe)
- {name: MinIO username, type: String}  # MinIO username
- {name: MinIO password, type: String}  # MinIO password
outputs:
- {name: MinIO path, type: String}  # Output MinIO path
metadata:
  annotations:
    author: Nikhil <nikhil.v@mobiusdtaas.ai>
implementation:
    container:
        image: ubuntu:22.04
        command:
        - sh
        - -ex
        - -c
        - |
            # Update and install wget
            apt-get -o Acquire::ForceIPv4=true update
            apt-get -o Acquire::ForceIPv4=true install -y wget
            
            # Download and install MinIO client
            wget https://dl.min.io/client/mc/release/linux-amd64/mc
            chmod +x mc
            mv mc /usr/local/bin/
            
            # Set up MinIO alias with provided credentials
            mc alias set myminio http://minio-service.kubeflow.svc.cluster.local:9000 "$6" "$7"
            
            # Check if bucket exists, if not create it
            if ! mc ls myminio/"$4"; then
              mc mb myminio/"$4"
            fi
            
            # Handle config file - check if it's a directory or file
            if [ -d "$0" ]; then
              # If it's a directory, copy the first file found
              CONFIG_FILE=$(find "$0" -type f | head -n 1)
              mc cp "$CONFIG_FILE" "myminio/$4/$5/config.pbtxt"
            else
              mc cp "$0" "myminio/$4/$5/config.pbtxt"
            fi
            
            # Handle ONNX file - check if it's a directory or file
            if [ -d "$1" ]; then
              # If it's a directory, copy the first file found
              ONNX_FILE=$(find "$1" -type f | head -n 1)
              mc cp "$ONNX_FILE" "myminio/$4/$5/1/model.onnx"
            else
              mc cp "$1" "myminio/$4/$5/1/model.onnx"
            fi
            
            # Handle Data file - check if it's a directory or file
            if [ -d "$2" ]; then
              # If it's a directory, copy the first file found
              DATA_FILE=$(find "$2" -type f | head -n 1)
              mc cp "$DATA_FILE" "myminio/$4/$5/1/$3"
            else
              mc cp "$2" "myminio/$4/$5/1/$3"
            fi
            
            # Create output directory and save the MinIO path
            mkdir -p "$(dirname "$8")"
            echo "s3://$4/" > "$8"
        - inputPath: Config file
        - inputPath: ONNX file
        - inputPath: Data file
        - inputValue: Data file name
        - inputValue: MinIO bucket name
        - inputValue: Model name
        - inputValue: MinIO username
        - inputValue: MinIO password
        - outputPath: MinIO path
